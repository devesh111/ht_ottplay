generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTH & USERS
// ============================================================================

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  phone             String?   @unique
  passwordHash      String
  firstName_en      String?
  firstName_ar      String?
  lastName_en       String?
  lastName_ar       String?
  profileImage      String?
  bio_en            String?
  bio_ar            String?
  preferredLanguage String    @default("en")
  isActive          Boolean   @default(true)
  isVerified        Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  otpRecords        OTPRecord[]
  userPreferences   UserPreferences?
  watchlist         Watchlist[]
  subscriptions     Subscription[]
  reviews           Review[]
  ratings           Rating[]
  articles          Article[]

  @@index([email])
  @@index([phone])
  @@index([isActive])
}

model OTPRecord {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  phone     String?
  email     String?
  otp       String
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([phone])
  @@index([email])
  @@index([expiresAt])
}

model UserPreferences {
  id                    String   @id @default(uuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  favoriteGenres_en     String[] @default([])
  favoriteGenres_ar     String[] @default([])
  favoriteLanguages     String[] @default(["en"])
  emailNotifications    Boolean  @default(true)
  pushNotifications     Boolean  @default(true)
  smsNotifications      Boolean  @default(false)
  isProfilePublic       Boolean  @default(false)
  allowRecommendations  Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([userId])
}

// ============================================================================
// CONTENT
// ============================================================================

model Genre {
  id          String   @id @default(uuid())
  name_en     String
  name_ar     String
  slug        String   @unique
  description_en String?
  description_ar String?
  icon        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  movies      Movie[]
  shows       Show[]
  articles    Article[]

  @@index([slug])
}

model Movie {
  id              String   @id @default(uuid())
  title_en        String
  title_ar        String
  slug            String   @unique
  description_en  String
  description_ar  String
  releaseDate     DateTime
  duration        Int
  rating          Float?
  posterUrl       String?
  thumbnailUrl    String?
  backdropUrl     String?
  trailerUrl      String?
  director_en     String?
  director_ar     String?
  cast_en         String?
  cast_ar         String?
  language        String   @default("en")
  country         String?
  ageRating       String   @default("PG")
  genreId         String
  genre           Genre    @relation(fields: [genreId], references: [id])
  isAvailable     Boolean  @default(true)
  availableFrom   DateTime?
  availableUntil  DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  streamingPlatforms StreamingPlatformMovie[]
  watchlist       Watchlist[]
  reviews         Review[]
  ratings         Rating[]

  @@index([slug])
  @@index([genreId])
  @@index([isAvailable])
  @@index([releaseDate])
}

model Show {
  id              String   @id @default(uuid())
  title_en        String
  title_ar        String
  slug            String   @unique
  description_en  String
  description_ar  String
  releaseDate     DateTime
  endDate         DateTime?
  totalSeasons    Int      @default(1)
  totalEpisodes   Int      @default(0)
  rating          Float?
  posterUrl       String?
  thumbnailUrl    String?
  backdropUrl     String?
  trailerUrl      String?
  creator_en      String?
  creator_ar      String?
  cast_en         String?
  cast_ar         String?
  language        String   @default("en")
  country         String?
  ageRating       String   @default("PG")
  genreId         String
  genre           Genre    @relation(fields: [genreId], references: [id])
  isAvailable     Boolean  @default(true)
  availableFrom   DateTime?
  availableUntil  DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  seasons         Season[]
  streamingPlatforms StreamingPlatformShow[]
  watchlist       Watchlist[]
  reviews         Review[]
  ratings         Rating[]

  @@index([slug])
  @@index([genreId])
  @@index([isAvailable])
}

model Season {
  id              String   @id @default(uuid())
  showId          String
  show            Show     @relation(fields: [showId], references: [id], onDelete: Cascade)
  seasonNumber    Int
  title_en        String?
  title_ar        String?
  description_en  String?
  description_ar  String?
  releaseDate     DateTime?
  posterUrl       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  episodes        Episode[]

  @@unique([showId, seasonNumber])
  @@index([showId])
}

model Episode {
  id              String   @id @default(uuid())
  seasonId        String
  season          Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  episodeNumber   Int
  title_en        String
  title_ar        String
  description_en  String?
  description_ar  String?
  duration        Int
  releaseDate     DateTime
  thumbnailUrl    String?
  videoUrl        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([seasonId, episodeNumber])
  @@index([seasonId])
}

model LiveTV {
  id              String   @id @default(uuid())
  name_en         String
  name_ar         String
  slug            String   @unique
  description_en  String?
  description_ar  String?
  logoUrl         String?
  streamUrl       String
  category_en     String?
  category_ar     String?
  language        String   @default("en")
  country         String?
  isLive          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  streamingPlatforms StreamingPlatformLiveTV[]

  @@index([slug])
  @@index([isLive])
}

model StreamingPlatform {
  id              String   @id @default(uuid())
  name            String   @unique
  slug            String   @unique
  logo            String?
  website         String?
  description     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  movies          StreamingPlatformMovie[]
  shows           StreamingPlatformShow[]
  liveTVs         StreamingPlatformLiveTV[]
  subscriptionPlans SubscriptionPlan[]

  @@index([slug])
}

model StreamingPlatformMovie {
  id              String   @id @default(uuid())
  movieId         String
  movie           Movie    @relation(fields: [movieId], references: [id], onDelete: Cascade)
  platformId      String
  platform        StreamingPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)
  availableFrom   DateTime?
  availableUntil  DateTime?
  isAvailable     Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([movieId, platformId])
  @@index([movieId])
  @@index([platformId])
}

model StreamingPlatformShow {
  id              String   @id @default(uuid())
  showId          String
  show            Show     @relation(fields: [showId], references: [id], onDelete: Cascade)
  platformId      String
  platform        StreamingPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)
  availableFrom   DateTime?
  availableUntil  DateTime?
  isAvailable     Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([showId, platformId])
  @@index([showId])
  @@index([platformId])
}

model StreamingPlatformLiveTV {
  id              String   @id @default(uuid())
  liveTVId        String
  liveTV          LiveTV   @relation(fields: [liveTVId], references: [id], onDelete: Cascade)
  platformId      String
  platform        StreamingPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)
  availableFrom   DateTime?
  availableUntil  DateTime?
  isAvailable     Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([liveTVId, platformId])
  @@index([liveTVId])
  @@index([platformId])
}

// ============================================================================
// WATCHLIST & RATINGS
// ============================================================================

model Watchlist {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  movieId         String?
  movie           Movie?   @relation(fields: [movieId], references: [id], onDelete: Cascade)
  showId          String?
  show            Show?    @relation(fields: [showId], references: [id], onDelete: Cascade)
  watchedProgress Int      @default(0)
  status          String   @default("to_watch")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, movieId])
  @@unique([userId, showId])
  @@index([userId])
  @@index([movieId])
  @@index([showId])
}

model Rating {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  movieId         String?
  movie           Movie?   @relation(fields: [movieId], references: [id], onDelete: Cascade)
  showId          String?
  show            Show?    @relation(fields: [showId], references: [id], onDelete: Cascade)
  score           Float
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, movieId])
  @@unique([userId, showId])
  @@index([userId])
  @@index([movieId])
  @@index([showId])
}

model Review {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  movieId         String?
  movie           Movie?   @relation(fields: [movieId], references: [id], onDelete: Cascade)
  showId          String?
  show            Show?    @relation(fields: [showId], references: [id], onDelete: Cascade)
  title_en        String
  title_ar        String
  content_en      String
  content_ar      String
  rating          Float
  isVerified      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([movieId])
  @@index([showId])
}

// ============================================================================
// SUBSCRIPTIONS & PLANS
// ============================================================================

model SubscriptionPlan {
  id              String   @id @default(uuid())
  platformId      String
  platform        StreamingPlatform @relation(fields: [platformId], references: [id], onDelete: Cascade)
  name_en         String
  name_ar         String
  description_en  String?
  description_ar  String?
  price           Float
  currency        String   @default("USD")
  maxDevices      Int      @default(1)
  maxQuality      String   @default("HD")
  adSupported     Boolean  @default(false)
  offlineDownload Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  subscriptions   Subscription[]

  @@index([platformId])
}

model Subscription {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  planId          String
  plan            SubscriptionPlan @relation(fields: [planId], references: [id])
  status          String   @default("active")
  startDate       DateTime @default(now())
  endDate         DateTime?
  renewalDate     DateTime?
  paymentMethod   String?
  lastPaymentDate DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([planId])
  @@index([status])
}

// ============================================================================
// ARTICLES (NEWS & REVIEWS)
// ============================================================================

model Article {
  id              String   @id @default(uuid())
  title_en        String
  title_ar        String
  slug            String   @unique
  content_en      String
  content_ar      String
  excerpt_en      String?
  excerpt_ar      String?
  authorId        String
  author          User     @relation(fields: [authorId], references: [id])
  genreId         String?
  genre           Genre?   @relation(fields: [genreId], references: [id])
  featuredImage   String?
  isPublished     Boolean  @default(false)
  publishedAt     DateTime?
  metaDescription_en String?
  metaDescription_ar String?
  metaKeywords_en String?
  metaKeywords_ar String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([slug])
  @@index([authorId])
  @@index([genreId])
  @@index([isPublished])
  @@index([publishedAt])
}

model SearchLog {
  id              String   @id @default(uuid())
  query           String
  language        String   @default("en")
  resultsCount    Int      @default(0)
  createdAt       DateTime @default(now())

  @@index([query])
  @@index([createdAt])
}
